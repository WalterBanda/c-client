# TODO Update release workflow
name: Deployment to Google playstore
description: Workflow that signs the built apk and aab, deploys it to playstore

inputs:
  GOOGLE_SERVICE_ACCOUNT_KEY:
    description: Secret key for deploying apk to Google playstore
    required: true
  KEYSTORE_FILE:
    description: Keystore file for signing APK
    required: true
  KEY_ALIAS:
    description: Keystore alias for signing APK
    required: true
  KEY_PASSWORD:
    description: Keystore password for signing APK
    required: true

runs:
  using: composite
  steps:
    - name: Set up JDK
      uses: actions/setup-java@v1
      with:
        java-version: 14

    - name: Install Google Cloud SDK
      uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        version: 307.0.0

    - name: Sign Android APK
      shell: bash
      run: |
        echo $KEYSTORE_FILE | base64 --decode > keystore.jks
        jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore keystore.jks -storepass $KEY_PASSWORD -keypass $KEY_PASSWORD app/build/outputs/apk/release/app-release.apk $KEY_ALIAS

    - name: Deploy to Google Play Store
      uses: GoogleCloudPlatform/github-actions/deploy-google-play-store@master
      with:
        service_account_key: ${{ inputs.GOOGLE_SERVICE_ACCOUNT_KEY }}
        release_notes_file: CHANGELOG.md
        track: internal
        apk_file: app/build/outputs/apk/release/app-release.apk
        app_bundle_file: app/build/outputs/bundle/release/app.aab
